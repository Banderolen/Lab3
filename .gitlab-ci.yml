stages:
  - test
  - deploy

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

# ---------- TESTS ----------
pytest:
  stage: test
  image: python:3.11
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - pytest -q
  artifacts:
    when: always
    reports:
      junit: junit.xml
    paths:
      - .pytest_cache/
  only:
    - branches

# ---------- DEPLOY ----------
deploy_to_prod:
  stage: deploy
  tags:
    - prod
  only:
    - main
  before_script:
    - echo "Deploying to production server $(hostname)"
  script:
    - sudo mkdir -p /opt/lab_app
    - sudo rsync -a --delete ./ /opt/lab_app/
    - cd /opt/lab_app
    - python3 -m venv venv || true
    - source venv/bin/activate
    - pip install -r requirements.txt
    - deactivate
    - sudo systemctl daemon-reload
    - sudo systemctl restart lab_app.service
  environment:
    name: production
